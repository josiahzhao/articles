---
title: 【ElasticSearch系列连载】3. 如何安装符合生产环境要求的ES集群
categories:
- 技术手册
tags:
- 搜索
- ElasticSearch
date: 2022-05-22 00:46:25
---

上一节介绍的一键安装方式，可以快速启动一个ES环境用于学习，调试和测试，但是还不足以作为生产环境，比如：

- 不支持集群模式 done
- 无法轻易对配置文件进行调整与维护 done
- 后续写入的搜索数据会随着容器删除而删除，没有在本地进行持久化存储 done
- 9200端口暴露，不需要认证即可访问 done
- 没有可视化管理界面 done

如果想一步到位了解更详细的ES部署方式用于生产环境，可以继续阅读这一节。

所以，这一节将介绍如何部署一个具有**加密**且具有数据+配置文件**持久化存储**的ES**集群**（2个节点）


多机部署
docker rm -f learnes01
docker run --name learnes01 --net learnesnetwork -d -p 9200:9200 -p 9300:9300 --add-host learnes01:192.168.51.53 --add-host learnes02:192.168.51.121 -e "node.name=learnes01" -e "network.publish_host=192.168.51.53" -e "cluster.name=learnes-cluster" -e "discovery.seed_hosts=learnes02" -e "cluster.initial_master_nodes=learnes01,learnes02" elasticsearch:7.10.1

discovery.zen.ping.unicast.hosts: ["k8snode16","None","k8snode15","k8smaster01"]
#
# Prevent the "split brain" by configuring the majority of nodes (total number of master-eligible nodes / 2 + 1):
#
discovery.zen.minimum_master_nodes: 3


docker network create esnet



```
esname=$1
addhost=$2
escode=${esname:0-2: 2}
echo 要部署的ES节点名称:$esname
echo 使用的端口号:$escode
echo 要添加的hosts:$addhost

docker rm -f $esname
# rm -fr /data/elasticsearch/$esname
mkdir -p /data/elasticsearch/$esname/{data,logs,config}
chmod 777 -R /data/elasticsearch/$esname
# cp /data/elasticsearch/init_config/$esname/* /data/elasticsearch/$esname/config/
docker run \
--name $esname \
-d -p 92$escode:92$escode -p 93$escode:93$escode \
-v /data/elasticsearch/$esname/data:/usr/share/elasticsearch/data \
-v /data/elasticsearch/$esname/logs:/usr/share/elasticsearch/logs \
-v /data/elasticsearch/$esname/config:/usr/share/elasticsearch/config \
$addhost \
elasticsearch:7.10.1
```

./deploy_es.sh es00 '--add-host es00:192.168.51.121 --add-host es01:192.168.51.121 --add-host es02:192.168.51.53'
./deploy_es.sh es01 '--add-host es00:192.168.51.121 --add-host es01:192.168.51.121 --add-host es02:192.168.51.53'
./deploy_es.sh es02 '--add-host es00:192.168.51.121 --add-host es01:192.168.51.121 --add-host es02:192.168.51.53'

## 加密
```
./bin/elasticsearch-certutil ca
./bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12
mkdir ./config/certificates
mv ./elastic-certificates.p12 ./config/certificates/
chmod 777 ./config/certificates/elastic-certificates.p12

vi ./config/elasticsearch.yml

http.cors.enabled: true
http.cors.allow-origin: "*"
http.cors.allow-headers: Authorization,X-Requested-With,Content-Type,Content-Length

xpack.security.enabled: true
xpack.security.authc.accept_default_password: true
xpack.security.transport.ssl.enabled: true
xpack.security.transport.ssl.verification_mode: certificate
xpack.security.transport.ssl.keystore.path: /usr/share/elasticsearch/config/certificates/elastic-certificates.p12
xpack.security.transport.ssl.truststore.path: /usr/share/elasticsearch/config/certificates/elastic-certificates.p12

./bin/elasticsearch-keystore add xpack.security.transport.ssl.keystore.secure_password
./bin/elasticsearch-keystore add xpack.security.transport.ssl.truststore.secure_password

## 需要拷贝证书，不能重新生成
-------------
./bin/elasticsearch-setup-passwords  interactive

vi /usr/local/kibana/config/kibana.yml

添加：

elasticsearch.username: "kibana"

elasticsearch.password: "密码"


```

## kibana
docker rm -f kib
mkdir -p /data/kibana
chmod 777 -R /data/elasticsearch/$esname

```
#
# ** THIS IS AN AUTO-GENERATED FILE **
#

# Default Kibana configuration for docker target
server.name: kibana
server.host: "0"
elasticsearch.hosts: [ "http://elasticsearch:9200" ]
```

docker run \
--name kib \
-d -p 5601:5601 \
-v /data/kibana/kibana.yml:/usr/share/kibana/config/kibana.yml \
kibana:7.10.1




单机部署
docker rm -f learnes01
docker rm -f learnes02

docker run --name learnes01 --net learnesnetwork -d -p 9200:9200 -p 9300:9300 -e "node.name=learnes01" -e "cluster.name=learnes-cluster" -e "discovery.seed_hosts=learnes02" -e "cluster.initial_master_nodes=learnes01,learnes02" elasticsearch:7.10.1


docker run --name learnes02 --net learnesnetwork -d -e "node.name=learnes02" -e "cluster.name=learnes-cluster" -e "discovery.seed_hosts=learnes01" -e "cluster.initial_master_nodes=learnes01,learnes02" elasticsearch:7.10.1

开启认证

## 可能问题
docker存储性能问题

https://baijiahao.baidu.com/s?id=1703600336205273370&wfr=spider&for=pc
https://www.elastic.co/guide/en/elasticsearch/reference/7.10/settings.html
https://stackoverflow.com/questions/66433674/what-does-discovery-seed-hosts-and-cluster-initial-master-nodes-mean-in-es
https://stackoverflow.com/questions/14379575/configure-port-number-of-elasticsearch

sysctl -w vm.max_map_count=262144

参考文档
https://blog.csdn.net/hhf799954772/article/details/115870012
https://blog.csdn.net/yabingshi_tech/article/details/109535035
https://www.elastic.co/guide/en/kibana/7.17/docker.html
https://www.elastic.co/guide/en/elasticsearch/reference/7.10/elasticsearch-intro.html
https://www.elastic.co/guide/en/elasticsearch/reference/7.10/docker.html
https://stackoverflow.com/questions/69415530/start-up-elastic-search-on-multiple-hosts-using-docker
https://discuss.elastic.co/t/handshake-failed-unexpected-remote-node/117082
https://docs.docker.com/engine/reference/run/#network-settings


